<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Translasi Titik</title>

  <!-- SDK paths dibuat relatif. Jika SDK tidak ada di folder _sdk, fallback mock akan dipakai di script -->
  <script src="./_sdk/data_sdk.js"></script>
  <script src="./_sdk/element_sdk.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
        body {
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        * {
            font-family: 'Poppins', sans-serif;
        }

        .grid-bg {
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .step-card {
            transition: all 0.3s ease;
        }

        .step-card.active {
            transform: scale(1.02);
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.12);
        }

        .choice-btn {
            transition: all 0.2s ease;
        }

        .choice-btn:hover {
            transform: translateY(-2px);
        }

        .choice-btn.correct {
            animation: correct-pulse 0.35s ease;
        }

        .choice-btn.incorrect {
            animation: shake 0.35s ease;
        }

        @keyframes correct-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-6px); }
            75% { transform: translateX(6px); }
        }

        .fade-in {
            animation: fadeIn 0.45s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* small helper for svg responsiveness */
        .coord-svg { max-width: 100%; height: auto; display: block; margin: 0 auto; }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-slate-900">
  <div id="app" class="w-full h-full overflow-auto"></div>

  <script>
        // --- fallback mocks untuk SDK (dipakai jika file SDK tidak ditemukan) ---
        (function ensureSDKFallbacks(){
            // Jika dataSdk / elementSdk belum terdefinisi oleh skrip eksternal, sediakan mock sederhana
            if (!window.dataSdk) {
                (function(){
                    let stored = [];
                    let handler = null;
                    window.dataSdk = {
                        init: async (dataHandler) => {
                            handler = dataHandler || null;
                            // beri handler data kosong di awal
                            if (handler && typeof handler.onDataChanged === 'function') {
                                handler.onDataChanged(stored);
                            }
                            return { isOk: true };
                        },
                        create: async (item) => {
                            stored.push(item);
                            if (handler && typeof handler.onDataChanged === 'function') {
                                handler.onDataChanged(stored);
                            }
                            return { isOk: true };
                        },
                        // tambahan util untuk debugging
                        __getAll: () => stored
                    };
                    console.warn("[dataSdk] fallback mock aktif (development). Jika Anda memiliki _sdk/data_sdk.js, abaikan pesan ini.");
                })();
            }

            if (!window.elementSdk) {
                window.elementSdk = {
                    init: (opts) => {
                        // simpan config jika dipanggil setConfig
                        window.elementSdk._config = opts && opts.defaultConfig ? { ...opts.defaultConfig } : {};
                        window.elementSdk.setConfig = (cfg) => {
                            window.elementSdk._config = { ...window.elementSdk._config, ...cfg };
                            if (opts && typeof opts.onConfigChange === 'function') {
                                opts.onConfigChange(window.elementSdk._config);
                            }
                        };
                        return;
                    },
                    setConfig: () => {}
                };
                console.warn("[elementSdk] fallback mock aktif (development). Jika Anda memiliki _sdk/element_sdk.js, abaikan pesan ini.");
            }
        })();

        // --- konfigurasi default dan state aplikasi ---
        const defaultConfig = {
            background_color: "#0f172a",
            card_color: "#1e293b",
            text_color: "#f1f5f9",
            primary_action_color: "#6366f1",
            secondary_action_color: "#10b981",
            font_family: "Poppins",
            font_size: 16,
            app_title: "Translasi Titik",
            subtitle: "Belajar Transformasi Geometri",
            new_problem_button: "Soal Baru",
            check_answer_button: "Periksa Jawaban"
        };

        let config = { ...defaultConfig };
        let currentProblem = null;
        let currentStep = 0;
        let selectedAnswer = null;
        let problemHistory = [];
        let isLoading = false;
        let showHint = false;
        let learningMode = null; // null, 'bayangan', 'titik_asal', 'translasi'
        let completedSteps = [];
        let currentChoices = null;

        // definisi langkah-langkah (sama seperti versi awal, disesuaikan)
        const steps = [
            // mode bayangan
            {
                title: "Langkah 1: Identifikasi Titik Awal",
                question: "Apa koordinat titik awal?",
                formula: "A(x, y)",
                hint: "Titik awal adalah titik sebelum dilakukan translasi",
                getChoices: (problem) => {
                    return [
                        { text: `A(${problem.point_x}, ${problem.point_y})`, correct: true },
                        { text: `A(${problem.point_y}, ${problem.point_x})`, correct: false },
                        { text: `A(${-problem.point_x}, ${problem.point_y})`, correct: false },
                        { text: `A(${problem.point_x}, ${-problem.point_y})`, correct: false }
                    ];
                },
                explanation: (problem) => `Titik awal adalah A(${problem.point_x}, ${problem.point_y}), dimana x = ${problem.point_x} dan y = ${problem.point_y}`,
                modes: ['bayangan']
            },
            {
                title: "Langkah 2: Identifikasi Vektor Translasi",
                question: "Berapa nilai a dan b dari vektor translasi T(a, b)?",
                formula: "T(a, b)",
                hint: "Nilai a adalah pergeseran horizontal, nilai b adalah pergeseran vertikal",
                getChoices: (problem) => {
                    return [
                        { text: `a = ${problem.translation_x}, b = ${problem.translation_y}`, correct: true },
                        { text: `a = ${problem.translation_y}, b = ${problem.translation_x}`, correct: false },
                        { text: `a = ${-problem.translation_x}, b = ${problem.translation_y}`, correct: false },
                        { text: `a = ${problem.translation_x}, b = ${-problem.translation_y}`, correct: false }
                    ];
                },
                explanation: (problem) => `Dari T(${problem.translation_x}, ${problem.translation_y}), kita dapatkan: a = ${problem.translation_x} dan b = ${problem.translation_y}`,
                modes: ['bayangan']
            },
            {
                title: "Langkah 3: Hitung Koordinat X Baru",
                question: "Berapa koordinat x' setelah translasi?",
                formula: "x' = x + a",
                hint: (problem) => `Gunakan rumus x' = x + a, dimana x = ${problem.point_x} dan a = ${problem.translation_x}`,
                getChoices: (problem) => {
                    const correct = problem.point_x + problem.translation_x;
                    return [
                        { text: `x' = ${correct}`, correct: true },
                        { text: `x' = ${problem.point_x - problem.translation_x}`, correct: false },
                        { text: `x' = ${problem.point_x + problem.translation_y}`, correct: false },
                        { text: `x' = ${problem.point_x}`, correct: false }
                    ];
                },
                explanation: (problem) => {
                    const result = problem.point_x + problem.translation_x;
                    return `Menggunakan rumus x' = x + a ‚Üí x' = ${problem.point_x} + (${problem.translation_x}) = ${result}`;
                },
                modes: ['bayangan']
            },
            {
                title: "Langkah 4: Hitung Koordinat Y Baru",
                question: "Berapa koordinat y' setelah translasi?",
                formula: "y' = y + b",
                hint: (problem) => `Gunakan rumus y' = y + b, dimana y = ${problem.point_y} dan b = ${problem.translation_y}`,
                getChoices: (problem) => {
                    const correct = problem.point_y + problem.translation_y;
                    return [
                        { text: `y' = ${correct}`, correct: true },
                        { text: `y' = ${problem.point_y - problem.translation_y}`, correct: false },
                        { text: `y' = ${problem.point_y + problem.translation_x}`, correct: false },
                        { text: `y' = ${problem.point_y}`, correct: false }
                    ];
                },
                explanation: (problem) => {
                    const result = problem.point_y + problem.translation_y;
                    return `Menggunakan rumus y' = y + b ‚Üí y' = ${problem.point_y} + (${problem.translation_y}) = ${result}`;
                },
                modes: ['bayangan']
            },
            {
                title: "Langkah 5: Tentukan Bayangan",
                question: "Apa koordinat bayangan titik A?",
                formula: "A'(x', y') = A(x + a, y + b)",
                hint: (problem) => {
                    const x_new = problem.point_x + problem.translation_x;
                    const y_new = problem.point_y + problem.translation_y;
                    return `Gabungkan hasil x' dan y' yang sudah dihitung: A'(${x_new}, ${y_new})`;
                },
                getChoices: (problem) => {
                    const x_new = problem.point_x + problem.translation_x;
                    const y_new = problem.point_y + problem.translation_y;
                    return [
                        { text: `A'(${x_new}, ${y_new})`, correct: true },
                        { text: `A'(${y_new}, ${x_new})`, correct: false },
                        { text: `A'(${problem.point_x}, ${problem.point_y})`, correct: false },
                        { text: `A'(${x_new - problem.translation_x * 2}, ${y_new})`, correct: false }
                    ];
                },
                explanation: (problem) => {
                    const x_new = problem.point_x + problem.translation_x;
                    const y_new = problem.point_y + problem.translation_y;
                    return `Bayangan titik A adalah A'(${x_new}, ${y_new}) dari hasil x' = ${x_new} dan y' = ${y_new}`;
                },
                modes: ['bayangan']
            },

            // titik_asal mode
            {
                title: "Langkah 1: Identifikasi Bayangan dan Translasi",
                question: "Apa yang diketahui dari soal?",
                formula: "A'(x', y') dan T(a, b)",
                hint: "Catat koordinat bayangan A' dan vektor translasi T",
                getChoices: (problem) => {
                    const x_new = problem.point_x + problem.translation_x;
                    const y_new = problem.point_y + problem.translation_y;
                    return [
                        { text: `A'(${x_new}, ${y_new}) dan T(${problem.translation_x}, ${problem.translation_y})`, correct: true },
                        { text: `A'(${y_new}, ${x_new}) dan T(${problem.translation_x}, ${problem.translation_y})`, correct: false },
                        { text: `A'(${x_new}, ${y_new}) dan T(${problem.translation_y}, ${problem.translation_x})`, correct: false },
                        { text: `A(${problem.point_x}, ${problem.point_y}) dan T(${problem.translation_x}, ${problem.translation_y})`, correct: false }
                    ];
                },
                explanation: (problem) => {
                    const x_new = problem.point_x + problem.translation_x;
                    const y_new = problem.point_y + problem.translation_y;
                    return `Yang diketahui: Bayangan A'(${x_new}, ${y_new}) dan Translasi T(${problem.translation_x}, ${problem.translation_y})`;
                },
                modes: ['titik_asal']
            },
            {
                title: "Langkah 2: Rumus Mencari Titik Asal",
                question: "Rumus apa yang digunakan untuk mencari titik asal?",
                formula: "x = x' - a dan y = y' - b",
                hint: "Untuk mencari titik asal, kita kurangkan vektor translasi dari bayangan",
                getChoices: (problem) => {
                    return [
                        { text: `x = x' - a dan y = y' - b`, correct: true },
                        { text: `x = x' + a dan y = y' + b`, correct: false },
                        { text: `x' = x - a dan y' = y - b`, correct: false },
                        { text: `x = x' √ó a dan y = y' √ó b`, correct: false }
                    ];
                },
                explanation: (problem) => `Untuk mencari titik asal dari bayangan, gunakan rumus: x = x' - a dan y = y' - b`,
                modes: ['titik_asal']
            },
            {
                title: "Langkah 3: Hitung Koordinat X Asal",
                question: "Berapa koordinat x dari titik asal?",
                formula: "x = x' - a",
                hint: (problem) => {
                    const x_new = problem.point_x + problem.translation_x;
                    return `Gunakan rumus x = x' - a, dimana x' = ${x_new} dan a = ${problem.translation_x}`;
                },
                getChoices: (problem) => {
                    const x_new = problem.point_x + problem.translation_x;
                    return [
                        { text: `x = ${problem.point_x}`, correct: true },
                        { text: `x = ${x_new + problem.translation_x}`, correct: false },
                        { text: `x = ${x_new - problem.translation_y}`, correct: false },
                        { text: `x = ${x_new}`, correct: false }
                    ];
                },
                explanation: (problem) => {
                    const x_new = problem.point_x + problem.translation_x;
                    return `Menggunakan rumus x = x' - a ‚Üí x = ${x_new} - (${problem.translation_x}) = ${problem.point_x}`;
                },
                modes: ['titik_asal']
            },
            {
                title: "Langkah 4: Hitung Koordinat Y Asal",
                question: "Berapa koordinat y dari titik asal?",
                formula: "y = y' - b",
                hint: (problem) => {
                    const y_new = problem.point_y + problem.translation_y;
                    return `Gunakan rumus y = y' - b, dimana y' = ${y_new} dan b = ${problem.translation_y}`;
                },
                getChoices: (problem) => {
                    const y_new = problem.point_y + problem.translation_y;
                    return [
                        { text: `y = ${problem.point_y}`, correct: true },
                        { text: `y = ${y_new + problem.translation_y}`, correct: false },
                        { text: `y = ${y_new - problem.translation_x}`, correct: false },
                        { text: `y = ${y_new}`, correct: false }
                    ];
                },
                explanation: (problem) => {
                    const y_new = problem.point_y + problem.translation_y;
                    return `Menggunakan rumus y = y' - b ‚Üí y = ${y_new} - (${problem.translation_y}) = ${problem.point_y}`;
                },
                modes: ['titik_asal']
            },
            {
                title: "Langkah 5: Tentukan Titik Asal",
                question: "Apa koordinat titik asal A?",
                formula: "A(x, y) = A(x' - a, y' - b)",
                hint: (problem) => `Gabungkan hasil x dan y yang sudah dihitung`,
                getChoices: (problem) => {
                    return [
                        { text: `A(${problem.point_x}, ${problem.point_y})`, correct: true },
                        { text: `A(${problem.point_y}, ${problem.point_x})`, correct: false },
                        { text: `A(${-problem.point_x}, ${problem.point_y})`, correct: false },
                        { text: `A(${problem.point_x + problem.translation_x * 2}, ${problem.point_y})`, correct: false }
                    ];
                },
                explanation: (problem) => `Titik asal adalah A(${problem.point_x}, ${problem.point_y})`,
                modes: ['titik_asal']
            },

            // translasi mode
            {
                title: "Langkah 1: Identifikasi Titik Asal dan Bayangan",
                question: "Apa yang diketahui dari soal?",
                formula: "A(x, y) dan A'(x', y')",
                hint: "Catat koordinat titik asal A dan bayangan A'",
                getChoices: (problem) => {
                    const x_new = problem.point_x + problem.translation_x;
                    const y_new = problem.point_y + problem.translation_y;
                    return [
                        { text: `A(${problem.point_x}, ${problem.point_y}) dan A'(${x_new}, ${y_new})`, correct: true },
                        { text: `A(${problem.point_y}, ${problem.point_x}) dan A'(${x_new}, ${y_new})`, correct: false },
                        { text: `A(${problem.point_x}, ${problem.point_y}) dan A'(${y_new}, ${x_new})`, correct: false },
                        { text: `A(${x_new}, ${y_new}) dan A'(${problem.point_x}, ${problem.point_y})`, correct: false }
                    ];
                },
                explanation: (problem) => {
                    const x_new = problem.point_x + problem.translation_x;
                    const y_new = problem.point_y + problem.translation_y;
                    return `Yang diketahui: Titik asal A(${problem.point_x}, ${problem.point_y}) dan Bayangan A'(${x_new}, ${y_new})`;
                },
                modes: ['translasi']
            },
            {
                title: "Langkah 2: Rumus Mencari Translasi",
                question: "Rumus apa yang digunakan untuk mencari vektor translasi?",
                formula: "a = x' - x dan b = y' - y",
                hint: "Untuk mencari translasi, kurangkan titik asal dari bayangan",
                getChoices: (problem) => {
                    return [
                        { text: `a = x' - x dan b = y' - y`, correct: true },
                        { text: `a = x - x' dan b = y - y'`, correct: false },
                        { text: `a = x + x' dan b = y + y'`, correct: false },
                        { text: `a = x' √ó x dan b = y' √ó y`, correct: false }
                    ];
                },
                explanation: (problem) => `Untuk mencari vektor translasi, gunakan rumus: a = x' - x dan b = y' - y`,
                modes: ['translasi']
            },
            {
                title: "Langkah 3: Hitung Nilai a",
                question: "Berapa nilai a dari vektor translasi?",
                formula: "a = x' - x",
                hint: (problem) => {
                    const x_new = problem.point_x + problem.translation_x;
                    return `Gunakan rumus a = x' - x, dimana x' = ${x_new} dan x = ${problem.point_x}`;
                },
                getChoices: (problem) => {
                    return [
                        { text: `a = ${problem.translation_x}`, correct: true },
                        { text: `a = ${-problem.translation_x}`, correct: false },
                        { text: `a = ${problem.point_x + problem.translation_x}`, correct: false },
                        { text: `a = ${problem.point_x}`, correct: false }
                    ];
                },
                explanation: (problem) => {
                    const x_new = problem.point_x + problem.translation_x;
                    return `Menggunakan rumus a = x' - x ‚Üí a = ${x_new} - ${problem.point_x} = ${problem.translation_x}`;
                },
                modes: ['translasi']
            },
            {
                title: "Langkah 4: Hitung Nilai b",
                question: "Berapa nilai b dari vektor translasi?",
                formula: "b = y' - y",
                hint: (problem) => {
                    const y_new = problem.point_y + problem.translation_y;
                    return `Gunakan rumus b = y' - y, dimana y' = ${y_new} dan y = ${problem.point_y}`;
                },
                getChoices: (problem) => {
                    return [
                        { text: `b = ${problem.translation_y}`, correct: true },
                        { text: `b = ${-problem.translation_y}`, correct: false },
                        { text: `b = ${problem.point_y + problem.translation_y}`, correct: false },
                        { text: `b = ${problem.point_y}`, correct: false }
                    ];
                },
                explanation: (problem) => {
                    const y_new = problem.point_y + problem.translation_y;
                    return `Menggunakan rumus b = y' - y ‚Üí b = ${y_new} - ${problem.point_y} = ${problem.translation_y}`;
                },
                modes: ['translasi']
            },
            {
                title: "Langkah 5: Tentukan Vektor Translasi",
                question: "Apa vektor translasi T(a, b)?",
                formula: "T(a, b) = T(x' - x, y' - y)",
                hint: (problem) => `Gabungkan hasil a dan b yang sudah dihitung`,
                getChoices: (problem) => {
                    return [
                        { text: `T(${problem.translation_x}, ${problem.translation_y})`, correct: true },
                        { text: `T(${problem.translation_y}, ${problem.translation_x})`, correct: false },
                        { text: `T(${-problem.translation_x}, ${problem.translation_y})`, correct: false },
                        { text: `T(${problem.translation_x}, ${-problem.translation_y})`, correct: false }
                    ];
                },
                explanation: (problem) => `Vektor translasi adalah T(${problem.translation_x}, ${problem.translation_y})`,
                modes: ['translasi']
            }
        ];

        // util
        function generateProblem() {
            const point_x = Math.floor(Math.random() * 11) - 5;
            const point_y = Math.floor(Math.random() * 11) - 5;
            const translation_x = Math.floor(Math.random() * 9) - 4;
            const translation_y = Math.floor(Math.random() * 9) - 4;

            return {
                problem_id: `problem_${Date.now()}`,
                point_x,
                point_y,
                translation_x,
                translation_y,
                current_step: 0,
                completed: false,
                timestamp: new Date().toISOString()
            };
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // --- alur aplikasi ---
        function startNewProblem() {
            currentProblem = generateProblem();
            currentStep = 0;
            selectedAnswer = null;
            completedSteps = [];
            showHint = false;
            currentChoices = null;
            render();
        }

        function selectLearningMode(mode) {
            learningMode = mode;
            startNewProblem();
        }

        function backToMenu() {
            learningMode = null;
            currentProblem = null;
            currentStep = 0;
            selectedAnswer = null;
            completedSteps = [];
            showHint = false;
            currentChoices = null;
            render();
        }

        function getActiveSteps() {
            return steps.filter(step => step.modes.includes(learningMode));
        }

        async function checkAnswer(choiceIndex) {
            if (!currentChoices || selectedAnswer !== null || isLoading) return;

            selectedAnswer = choiceIndex;
            const isCorrect = currentChoices[choiceIndex].correct;

            render();

            if (isCorrect) {
                const activeSteps = getActiveSteps();
                const currentStepData = activeSteps[currentStep];

                completedSteps.push({
                    step: currentStep,
                    explanation: currentStepData.explanation(currentProblem),
                    title: currentStepData.title
                });

                await new Promise(resolve => setTimeout(resolve, 700));

                if (currentStep < activeSteps.length - 1) {
                    currentStep++;
                    selectedAnswer = null;
                    showHint = false;
                    currentChoices = null;
                } else {
                    // selesai
                    currentProblem.current_step = currentStep;
                    currentProblem.completed = true;
                    currentProblem.mode = learningMode;

                    isLoading = true;
                    render();

                    const result = await window.dataSdk.create({
                        problem_id: currentProblem.problem_id,
                        point_x: currentProblem.point_x,
                        point_y: currentProblem.point_y,
                        translation_x: currentProblem.translation_x,
                        translation_y: currentProblem.translation_y,
                        current_step: currentStep,
                        completed: true,
                        timestamp: currentProblem.timestamp
                    });

                    isLoading = false;

                    if (!result.isOk) {
                        showMessage("Terjadi kesalahan saat menyimpan data", "error");
                    } else {
                        // update history lokal juga (jika SDK mock)
                        problemHistory.push(currentProblem);
                    }
                }
                render();
            } else {
                // incorrect: tunjukkan pesan sebentar
                await new Promise(resolve => setTimeout(resolve, 600));
                // jangan auto-move; biarkan pengguna coba lagi atau lihat hint
                render();
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-semibold shadow-lg z-50 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        function toggleHint() {
            showHint = !showHint;
            render();
        }

        // Gambar koordinat sederhana (grid)
        function drawCoordinateSystem(problem) {
            const gridSize = 12; // jumlah sel (lebar/tinggi)
            const cellSize = 28; // px per sel
            const originX = Math.floor(gridSize / 2);
            const originY = Math.floor(gridSize / 2);

            let svg = `<svg viewBox="0 0 ${gridSize * cellSize} ${gridSize * cellSize}" class="coord-svg" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Sistem koordinat">`;

            // background rect
            svg += `<rect x="0" y="0" width="${gridSize * cellSize}" height="${gridSize * cellSize}" fill="${config.card_color}" rx="8"/>`;

            // grid lines
            for (let i = 0; i <= gridSize; i++) {
                const pos = i * cellSize;
                svg += `<line x1="${pos}" y1="0" x2="${pos}" y2="${gridSize * cellSize}" stroke="${config.text_color}" stroke-width="0.5" opacity="0.12"/>`;
                svg += `<line x1="0" y1="${pos}" x2="${gridSize * cellSize}" y2="${pos}" stroke="${config.text_color}" stroke-width="0.5" opacity="0.12"/>`;
            }

            // axis
            svg += `<line x1="${originX * cellSize}" y1="0" x2="${originX * cellSize}" y2="${gridSize * cellSize}" stroke="${config.text_color}" stroke-width="1.5" opacity="0.7"/>`;
            svg += `<line x1="0" y1="${originY * cellSize}" x2="${gridSize * cellSize}" y2="${originY * cellSize}" stroke="${config.text_color}" stroke-width="1.5" opacity="0.7"/>`;

            // defs arrow
            svg += `<defs><marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="${config.secondary_action_color}"/></marker></defs>`;

            // titik A
            const px = (originX + problem.point_x) * cellSize;
            const py = (originY - problem.point_y) * cellSize;
            svg += `<circle cx="${px}" cy="${py}" r="6" fill="${config.primary_action_color}" />`;
            svg += `<text x="${px + 10}" y="${py - 8}" fill="${config.text_color}" font-size="12" font-weight="600">${'A'}</text>`;

            // jika sudah langkah 3 atau lebih (menunjukkan bayangan)
            if (currentStep >= 2 || learningMode === 'translasi' || learningMode === 'titik_asal') {
                const nx = (originX + problem.point_x + problem.translation_x) * cellSize;
                const ny = (originY - problem.point_y - problem.translation_y) * cellSize;

                svg += `<line x1="${px}" y1="${py}" x2="${nx}" y2="${ny}" stroke="${config.secondary_action_color}" stroke-width="2" stroke-dasharray="6,4" marker-end="url(#arrowhead)"/>`;
                svg += `<circle cx="${nx}" cy="${ny}" r="6" fill="${config.secondary_action_color}" />`;
                svg += `<text x="${nx + 10}" y="${ny - 8}" fill="${config.text_color}" font-size="12" font-weight="600">${"A'"}</text>`;
            }

            svg += `</svg>`;
            return svg;
        }

        async function onConfigChange(newConfig) {
            config = { ...newConfig };
            render();
        }

        // --- render UI ---
        function render() {
            const baseSize = config.font_size || defaultConfig.font_size;
            const customFont = config.font_family || defaultConfig.font_family;
            const fontStack = `${customFont}, Poppins, sans-serif`;

            const app = document.getElementById('app');

            if (!learningMode) {
                app.innerHTML = `
                    <div class="w-full h-full grid-bg overflow-auto p-4" style="background-color: ${config.background_color}; min-height:100vh;">
                        <div class="max-w-3xl mx-auto py-6">
                            <div class="text-center mb-6 fade-in px-2">
                                <h1 class="mb-2 font-bold" style="color: ${config.text_color}; font-family: ${fontStack}; font-size: ${baseSize * 1.8}px;">
                                    ${config.app_title || defaultConfig.app_title}
                                </h1>
                                <p class="mb-4" style="color: ${config.text_color}; opacity: 0.85; font-family: ${fontStack}; font-size: ${baseSize}px;">
                                    ${config.subtitle || defaultConfig.subtitle}
                                </p>
                            </div>

                            <div class="rounded-xl p-4 mb-6 shadow-lg fade-in" style="background-color: ${config.card_color};">
                                <h2 class="mb-4 text-center font-bold" style="color: ${config.primary_action_color}; font-family: ${fontStack}; font-size: ${baseSize * 1.2}px;">
                                    üéØ Pilih Materi Pembelajaran
                                </h2>

                                <div class="grid gap-4">
                                    <button onclick="selectLearningMode('bayangan')" class="w-full p-4 rounded-lg text-left transform hover:scale-105 transition-all" style="background-color: ${config.background_color}; color: ${config.text_color};">
                                        <div class="flex items-start gap-3">
                                            <div class="text-3xl">üìç</div>
                                            <div class="flex-1">
                                                <h3 class="font-bold mb-1" style="font-size:${baseSize * 1.05}px;">1. Mencari Bayangan Titik</h3>
                                                <p style="opacity:0.9; font-size:${baseSize * 0.9}px;">Belajar mencari koordinat bayangan dari titik yang ditranslasikan dengan vektor tertentu.</p>
                                            </div>
                                        </div>
                                    </button>

                                    <button onclick="selectLearningMode('titik_asal')" class="w-full p-4 rounded-lg text-left transform hover:scale-105 transition-all" style="background-color: ${config.background_color}; color: ${config.text_color};">
                                        <div class="flex items-start gap-3">
                                            <div class="text-3xl">üîç</div>
                                            <div class="flex-1">
                                                <h3 class="font-bold mb-1" style="font-size:${baseSize * 1.05}px;">2. Mencari Titik Asal</h3>
                                                <p style="opacity:0.9; font-size:${baseSize * 0.9}px;">Belajar mencari koordinat titik awal jika diketahui bayangan dan vektor translasinya.</p>
                                            </div>
                                        </div>
                                    </button>

                                    <button onclick="selectLearningMode('translasi')" class="w-full p-4 rounded-lg text-left transform hover:scale-105 transition-all" style="background-color: ${config.background_color}; color: ${config.text_color};">
                                        <div class="flex items-start gap-3">
                                            <div class="text-3xl">‚ÜóÔ∏è</div>
                                            <div class="flex-1">
                                                <h3 class="font-bold mb-1" style="font-size:${baseSize * 1.05}px;">3. Mencari Vektor Translasi</h3>
                                                <p style="opacity:0.9; font-size:${baseSize * 0.9}px;">Belajar mencari vektor translasi jika diketahui titik asal dan bayangannya.</p>
                                            </div>
                                        </div>
                                    </button>
                                </div>
                            </div>

                            <div class="text-center mt-6">
                                <p class="font-semibold" style="color: ${config.text_color}; opacity: 0.8;">üìä Total Soal Terselesaikan: ${problemHistory.length}</p>
                            </div>

                            <div class="mt-8 pt-6 border-t text-center" style="border-color: ${config.text_color}; border-opacity: 0.12;">
                                <p class="font-bold tracking-wider" style="color: ${config.primary_action_color}; font-size:${baseSize * 1.05}px;">MATHNOLOGY</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            if (!currentProblem) {
                startNewProblem();
                return;
            }

            const activeSteps = getActiveSteps();
            const step = activeSteps[currentStep];

            // Generate and shuffle choices once per step
            if (!currentChoices) {
                const originalChoices = step.getChoices(currentProblem);
                currentChoices = shuffleArray(originalChoices);
            }

            const isCompleted = currentStep === activeSteps.length - 1 && selectedAnswer !== null && currentChoices[selectedAnswer] && currentChoices[selectedAnswer].correct;

            // soal text
            const x_new = currentProblem.point_x + currentProblem.translation_x;
            const y_new = currentProblem.point_y + currentProblem.translation_y;
            let soalText = '';
            if (learningMode === 'bayangan') {
                soalText = `Titik A(${currentProblem.point_x}, ${currentProblem.point_y}) ditranslasikan oleh T(${currentProblem.translation_x}, ${currentProblem.translation_y}). Tentukan bayangan A'!`;
            } else if (learningMode === 'titik_asal') {
                soalText = `Bayangan titik A oleh translasi T(${currentProblem.translation_x}, ${currentProblem.translation_y}) adalah A'(${x_new}, ${y_new}). Tentukan koordinat titik A!`;
            } else if (learningMode === 'translasi') {
                soalText = `Titik A(${currentProblem.point_x}, ${currentProblem.point_y}) ditranslasikan menjadi A'(${x_new}, ${y_new}). Tentukan vektor translasi T!`;
            }

            const modeName = {
                'bayangan': 'Mencari Bayangan Titik',
                'titik_asal': 'Mencari Titik Asal',
                'translasi': 'Mencari Vektor Translasi'
            };

            app.innerHTML = `
                <div class="w-full h-full grid-bg p-4" style="background-color: ${config.background_color}; min-height:100vh;">
                    <div class="max-w-4xl mx-auto">
                        <div class="mb-4 flex flex-col sm:flex-row justify-between items-center gap-3">
                            <div class="flex items-center gap-2">
                                <button onclick="backToMenu()" class="px-3 py-2 rounded-lg" style="background-color: ${config.card_color}; color: ${config.text_color};">‚Üê Menu</button>
                                <h1 class="font-bold" style="color: ${config.text_color}; font-size:${baseSize * 1.1}px;">${modeName[learningMode]}</h1>
                            </div>
                            <button onclick="startNewProblem()" class="px-4 py-2 rounded-lg font-semibold" style="background-color: ${config.primary_action_color}; color: white;">${config.new_problem_button}</button>
                        </div>

                        <div class="rounded-xl p-4 mb-4 shadow-lg" style="background-color: ${config.card_color};">
                            <h2 class="mb-3 font-bold" style="color: ${config.text_color}; font-size:${baseSize * 1.05}px;">Soal:</h2>
                            <p class="mb-3" style="color: ${config.text_color}; opacity: 0.9; font-size:${baseSize * 0.95}px;">${soalText}</p>
                            ${drawCoordinateSystem(currentProblem)}
                        </div>

                        <div class="mb-4 flex gap-1.5">
                            ${activeSteps.map((s, idx) => `
                                <div class="flex-1 h-1.5 rounded-full" style="background-color: ${idx <= currentStep ? config.primary_action_color : config.card_color};"></div>
                            `).join('')}
                        </div>

                        <div class="rounded-xl p-4 mb-4 shadow-lg step-card ${currentStep >= 0 ? 'active' : ''}">
                            <h3 class="mb-3 font-bold" style="color: ${config.primary_action_color}; font-size:${baseSize * 1.02}px;">${step.title}</h3>

                            ${step.formula ? `
                                <div class="mb-3 p-3 rounded" style="background-color: ${config.background_color};">
                                    <p class="mb-1" style="color: ${config.text_color}; opacity: 0.7; font-size:${baseSize * 0.8}px;">üìê Rumus:</p>
                                    <p class="font-bold" style="color: ${config.secondary_action_color}; font-size:${baseSize * 1.02}px;">${step.formula}</p>
                                </div>
                            ` : ''}

                            ${step.hint ? `
                                <div class="mb-3">
                                    <button onclick="toggleHint()" class="w-full sm:w-auto px-4 py-2 rounded-lg font-semibold mb-2" style="background-color: ${config.background_color}; color:${config.text_color};">
                                        ${showHint ? 'üîº Sembunyikan Petunjuk' : 'üí° Lihat Petunjuk'}
                                    </button>
                                    ${showHint ? `
                                        <div class="p-3 rounded" style="background-color: ${config.background_color}; border-left: 4px solid ${config.primary_action_color};">
                                            <p style="color: ${config.text_color}; opacity: 0.95;">üí° ${typeof step.hint === 'function' ? step.hint(currentProblem) : step.hint}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}

                            <p class="mb-4 font-semibold" style="color: ${config.text_color}; font-size:${baseSize * 0.95}px;">${step.question}</p>

                            <div class="grid gap-3 mb-4">
                                ${currentChoices.map((choice, idx) => {
                                    let bgColor = config.card_color;
                                    let textColor = config.text_color;
                                    let classes = 'choice-btn';
                                    if (selectedAnswer === idx) {
                                        if (choice.correct) {
                                            bgColor = config.secondary_action_color;
                                            textColor = '#ffffff';
                                            classes += ' correct';
                                        } else {
                                            bgColor = '#ef4444';
                                            textColor = '#ffffff';
                                            classes += ' incorrect';
                                        }
                                    }
                                    const disabled = selectedAnswer !== null ? 'pointer-events-none opacity-80' : '';
                                    return `
                                        <button onclick="checkAnswer(${idx})" class="${classes} ${disabled} p-3 rounded-lg text-left font-semibold" style="background-color:${bgColor}; color:${textColor}; border: 1px solid rgba(255,255,255,0.04);">
                                            ${String.fromCharCode(65 + idx)}. ${choice.text}
                                        </button>
                                    `;
                                }).join('')}
                            </div>

                            ${selectedAnswer !== null && currentChoices[selectedAnswer] && currentChoices[selectedAnswer].correct ? `
                                <div class="p-3 rounded fade-in" style="background-color: ${config.secondary_action_color}; color: ${config.text_color};">
                                    <p class="font-semibold">‚úì Benar! ${step.explanation(currentProblem)}</p>
                                </div>
                            ` : ''}
                        </div>

                        ${completedSteps.length > 0 ? `
                            <div class="mt-4 rounded-xl p-4 shadow-lg" style="background-color: ${config.card_color};">
                                <h3 class="mb-3 font-bold" style="color: ${config.primary_action_color}; font-size:${baseSize * 1.02}px;">üìã Pembahasan Lengkap</h3>
                                <div class="space-y-3">
                                    ${completedSteps.map((completed) => `
                                        <div class="p-3 rounded" style="background-color: ${config.background_color}; border-left: 3px solid ${config.secondary_action_color};">
                                            <h4 class="font-semibold" style="color: ${config.secondary_action_color};">${completed.title}</h4>
                                            <p style="color: ${config.text_color}; opacity: 0.95;">${completed.explanation}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${isCompleted ? `
                            <div class="mt-4 p-4 rounded text-center" style="background-color: ${config.primary_action_color}; color: ${config.text_color};">
                                <h3 class="font-bold">üéâ Selamat!</h3>
                                <p>Anda telah menyelesaikan soal translasi ini dengan sempurna!</p>
                            </div>
                        ` : ''}

                        ${isLoading ? `
                            <div class="text-center mt-4">
                                <p style="color: ${config.text_color}; opacity: 0.8;">Menyimpan progress...</p>
                            </div>
                        ` : ''}

                        <div class="text-center mt-8 pt-6 border-t" style="border-color: ${config.text_color}; border-opacity: 0.12;">
                            <p class="font-bold tracking-wider" style="color: ${config.primary_action_color};">MATHNOLOGY</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // data handler untuk SDK
        const dataHandler = {
            onDataChanged(data) {
                problemHistory = data || [];
                render();
            }
        };

        // init aplikasi
        async function init() {
            const initResult = await window.dataSdk.init(dataHandler);
            if (!initResult.isOk) {
                console.error("Failed to initialize data SDK");
            }

            window.elementSdk.init({
                defaultConfig,
                onConfigChange,
                mapToCapabilities: (cfg) => ({
                    recolorables: [
                        {
                            get: () => cfg.background_color || defaultConfig.background_color,
                            set: (value) => {
                                cfg.background_color = value;
                                window.elementSdk.setConfig({ background_color: value });
                            }
                        },
                        {
                            get: () => cfg.card_color || defaultConfig.card_color,
                            set: (value) => {
                                cfg.card_color = value;
                                window.elementSdk.setConfig({ card_color: value });
                            }
                        },
                        {
                            get: () => cfg.text_color || defaultConfig.text_color,
                            set: (value) => {
                                cfg.text_color = value;
                                window.elementSdk.setConfig({ text_color: value });
                            }
                        },
                        {
                            get: () => cfg.primary_action_color || defaultConfig.primary_action_color,
                            set: (value) => {
                                cfg.primary_action_color = value;
                                window.elementSdk.setConfig({ primary_action_color: value });
                            }
                        },
                        {
                            get: () => cfg.secondary_action_color || defaultConfig.secondary_action_color,
                            set: (value) => {
                                cfg.secondary_action_color = value;
                                window.elementSdk.setConfig({ secondary_action_color: value });
                            }
                        }
                    ],
                    borderables: [],
                    fontEditable: {
                        get: () => cfg.font_family || defaultConfig.font_family,
                        set: (value) => {
                            cfg.font_family = value;
                            window.elementSdk.setConfig({ font_family: value });
                        }
                    },
                    fontSizeable: {
                        get: () => cfg.font_size || defaultConfig.font_size,
                        set: (value) => {
                            cfg.font_size = value;
                            window.elementSdk.setConfig({ font_size: value });
                        }
                    }
                }),
                mapToEditPanelValues: (cfg) => new Map([
                    ["app_title", cfg.app_title || defaultConfig.app_title],
                    ["subtitle", cfg.subtitle || defaultConfig.subtitle],
                    ["new_problem_button", cfg.new_problem_button || defaultConfig.new_problem_button],
                    ["check_answer_button", cfg.check_answer_button || defaultConfig.check_answer_button]
                ])
            });

            render();
        }

        init();
  </script>
 </body>
</html>
