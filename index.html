<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Translasi Titik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        body { box-sizing: border-box; }
        * { font-family: 'Poppins', sans-serif; }
        
        .grid-bg {
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .choice-btn { transition: all 0.2s ease; }
        .choice-btn:hover:not(:disabled) { transform: translateY(-2px); }
        
        .choice-btn.correct { 
            background-color: #10b981 !important; 
            border-color: #10b981 !important;
            animation: correct-pulse 0.5s ease;
        }
        
        .choice-btn.incorrect { 
            background-color: #ef4444 !important;
            border-color: #ef4444 !important;
            opacity: 0.7;
            animation: shake 0.5s ease;
        }
        
        @keyframes correct-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .fade-in { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
 </head>
 <body class="h-full bg-slate-900 text-slate-100">
  <div id="app" class="w-full h-full overflow-auto"></div>

  <script>
        // --- MOCK SDK (Agar tidak error saat dijalankan lokal) ---
        window.dataSdk = {
            create: async (data) => {
                console.log("Data saved to SDK:", data);
                return { isOk: true };
            }
        };
        // --------------------------------------------------------

        const defaultConfig = {
            background_color: "#0f172a",
            card_color: "#1e293b",
            text_color: "#f1f5f9",
            primary_action_color: "#6366f1",
            secondary_action_color: "#10b981",
            font_family: "Poppins",
            font_size: 16,
            app_title: "Translasi Titik",
            subtitle: "Belajar Transformasi Geometri",
        };
        
        let config = { ...defaultConfig };
        let currentProblem = null;
        let currentStep = 0;
        let selectedAnswer = null;
        let learningMode = null; // null, 'bayangan', 'titik_asal', 'translasi'
        let completedSteps = [];
        let currentChoices = null;
        let isLoading = false;
        let showHint = false;

        // Data Steps (Sesuai kode asli Anda)
        const steps = [
            // ... (Kode steps sama seperti yang Anda miliki, saya ringkas logikanya di sini)
            {
                title: "Langkah 1: Identifikasi Titik Awal",
                question: "Apa koordinat titik awal?",
                hint: "Titik awal adalah titik sebelum dilakukan translasi",
                getChoices: (p) => [
                    { text: `A(${p.point_x}, ${p.point_y})`, correct: true },
                    { text: `A(${p.point_y}, ${p.point_x})`, correct: false },
                    { text: `A(${-p.point_x}, ${p.point_y})`, correct: false },
                    { text: `A(${p.point_x}, ${-p.point_y})`, correct: false }
                ],
                explanation: (p) => `Titik awal adalah A(${p.point_x}, ${p.point_y})`,
                modes: ['bayangan']
            },
            {
                title: "Langkah 2: Identifikasi Vektor Translasi",
                question: "Berapa nilai a dan b dari vektor translasi?",
                hint: "a = horizontal, b = vertikal",
                getChoices: (p) => [
                    { text: `a = ${p.translation_x}, b = ${p.translation_y}`, correct: true },
                    { text: `a = ${p.translation_y}, b = ${p.translation_x}`, correct: false },
                    { text: `a = ${-p.translation_x}, b = ${p.translation_y}`, correct: false },
                    { text: `a = ${p.translation_x}, b = ${-p.translation_y}`, correct: false }
                ],
                explanation: (p) => `Vektor translasi a=${p.translation_x}, b=${p.translation_y}`,
                modes: ['bayangan']
            },
            {
                title: "Langkah 3: Hitung Hasil Translasi",
                question: "Berapa koordinat bayangan A'?",
                hint: "Rumus: A'(x+a, y+b)",
                getChoices: (p) => {
                    const nx = p.point_x + p.translation_x;
                    const ny = p.point_y + p.translation_y;
                    return [
                        { text: `A'(${nx}, ${ny})`, correct: true },
                        { text: `A'(${ny}, ${nx})`, correct: false },
                        { text: `A'(${p.point_x}, ${p.point_y})`, correct: false },
                        { text: `A'(${nx-2}, ${ny})`, correct: false }
                    ];
                },
                explanation: (p) => `Bayangan A' adalah (${p.point_x + p.translation_x}, ${p.point_y + p.translation_y})`,
                modes: ['bayangan']
            },
            // Mode Titik Asal (Simplified for fix)
             {
                title: "Mencari Titik Asal",
                question: "Jika diketahui Bayangan A' dan Translasi T, di mana A?",
                hint: "Rumus: x = x' - a, y = y' - b",
                getChoices: (p) => [
                    { text: `A(${p.point_x}, ${p.point_y})`, correct: true },
                    { text: `A(${p.point_x + p.translation_x}, ${p.point_y})`, correct: false },
                    { text: `A(${p.point_x}, ${p.point_y + p.translation_y})`, correct: false },
                    { text: `A(0, 0)`, correct: false }
                ],
                explanation: (p) => `Titik asal didapat dengan mengurangkan translasi dari bayangan: A(${p.point_x}, ${p.point_y})`,
                modes: ['titik_asal']
            },
            // Mode Translasi (Simplified for fix)
            {
                title: "Mencari Vektor Translasi",
                question: "Jika diketahui A dan A', berapa T(a,b)?",
                hint: "Rumus: a = x' - x, b = y' - y",
                getChoices: (p) => [
                    { text: `T(${p.translation_x}, ${p.translation_y})`, correct: true },
                    { text: `T(${-p.translation_x}, ${p.translation_y})`, correct: false },
                    { text: `T(${p.translation_y}, ${p.translation_x})`, correct: false },
                    { text: `T(0, 0)`, correct: false }
                ],
                explanation: (p) => `Translasi T(${p.translation_x}, ${p.translation_y})`,
                modes: ['translasi']
            }
        ];

        function generateProblem() {
            return {
                problem_id: `problem_${Date.now()}`,
                point_x: Math.floor(Math.random() * 11) - 5,
                point_y: Math.floor(Math.random() * 11) - 5,
                translation_x: Math.floor(Math.random() * 9) - 4,
                translation_y: Math.floor(Math.random() * 9) - 4,
                timestamp: new Date().toISOString()
            };
        }

        function startNewProblem() {
            currentProblem = generateProblem();
            currentStep = 0;
            selectedAnswer = null;
            completedSteps = [];
            showHint = false;
            currentChoices = null;
            render();
        }
        
        function selectLearningMode(mode) {
            learningMode = mode;
            startNewProblem();
        }
        
        function backToMenu() {
            learningMode = null;
            render();
        }
        
        function getActiveSteps() {
            return steps.filter(step => step.modes.includes(learningMode));
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        async function checkAnswer(choiceIndex) {
            if (selectedAnswer !== null || isLoading) return;
            
            selectedAnswer = choiceIndex;
            const isCorrect = currentChoices[choiceIndex].correct;
            render(); // Re-render to show correct/incorrect state
            
            if (isCorrect) {
                const activeSteps = getActiveSteps();
                const currentStepData = activeSteps[currentStep];
                
                // Tambahkan delay sedikit agar user melihat hasil benar
                await new Promise(r => setTimeout(r, 800));

                completedSteps.push({
                    step: currentStep,
                    explanation: currentStepData.explanation(currentProblem),
                    title: currentStepData.title
                });
                
                if (currentStep < activeSteps.length - 1) {
                    currentStep++;
                    selectedAnswer = null;
                    showHint = false;
                    currentChoices = null;
                } else {
                    // Selesai semua step
                    isLoading = true;
                    render();
                    await window.dataSdk.create({ ...currentProblem, completed: true });
                    isLoading = false;
                    alert("Selamat! Latihan selesai. Kembali ke menu.");
                    backToMenu();
                    return; 
                }
                render();
            } else {
                 // Jawaban salah, reset selectedAnswer setelah delay agar bisa pilih lagi
                 setTimeout(() => {
                    selectedAnswer = null;
                    render();
                 }, 1000);
            }
        }

        function drawCoordinateSystem(problem) {
            const gridSize = 12;
            const cellSize = 30;
            const originX = gridSize / 2;
            const originY = gridSize / 2;
            
            let svg = `<svg viewBox="0 0 ${gridSize * cellSize} ${gridSize * cellSize}" class="w-full max-w-xs mx-auto my-4 bg-slate-800 rounded-lg border border-slate-700">`;
            
            // Grid lines
            for (let i = 0; i <= gridSize; i++) {
                const pos = i * cellSize;
                svg += `<line x1="${pos}" y1="0" x2="${pos}" y2="${gridSize * cellSize}" stroke="${config.text_color}" stroke-width="0.5" opacity="0.1"/>`;
                svg += `<line x1="0" y1="${pos}" x2="${gridSize * cellSize}" y2="${pos}" stroke="${config.text_color}" stroke-width="0.5" opacity="0.1"/>`;
            }
            
            // Axis
            svg += `<line x1="${originX * cellSize}" y1="0" x2="${originX * cellSize}" y2="${gridSize * cellSize}" stroke="${config.text_color}" stroke-width="2" opacity="0.5"/>`;
            svg += `<line x1="0" y1="${originY * cellSize}" x2="${gridSize * cellSize}" y2="${originY * cellSize}" stroke="${config.text_color}" stroke-width="2" opacity="0.5"/>`;
            
            // Points
            const px = (originX + problem.point_x) * cellSize;
            const py = (originY - problem.point_y) * cellSize;
            
            svg += `<circle cx="${px}" cy="${py}" r="5" fill="${config.primary_action_color}"/>`;
            svg += `<text x="${px + 8}" y="${py - 8}" fill="${config.text_color}" font-size="12">A</text>`;

            // Jika translasi sudah diketahui/selesai
            if (currentStep >= 1 || learningMode === 'titik_asal' || learningMode === 'translasi') {
                 const nx = (originX + problem.point_x + problem.translation_x) * cellSize;
                 const ny = (originY - problem.point_y - problem.translation_y) * cellSize;
                 
                 // Garis putus-putus translasi
                 svg += `<line x1="${px}" y1="${py}" x2="${nx}" y2="${ny}" stroke="${config.secondary_action_color}" stroke-width="2" stroke-dasharray="4,4" opacity="0.6"/>`;
                 
                 svg += `<circle cx="${nx}" cy="${ny}" r="5" fill="${config.secondary_action_color}"/>`;
                 svg += `<text x="${nx + 8}" y="${ny - 8}" fill="${config.text_color}" font-size="12">A'</text>`;
            }
            
            svg += `</svg>`;
            return svg;
        }

        // --- FUNGSI RENDER UTAMA YANG DILENGKAPI ---
        function render() {
            const app = document.getElementById('app');
            
            // 1. Render MENU UTAMA
            if (!learningMode) {
                app.innerHTML = `
                    <div class="w-full min-h-full grid-bg p-4 flex flex-col items-center justify-center">
                        <div class="max-w-2xl w-full text-center space-y-8 fade-in">
                            <div>
                                <h1 class="text-4xl font-bold mb-2 text-indigo-400">${config.app_title}</h1>
                                <p class="text-slate-400">${config.subtitle}</p>
                            </div>
                            
                            <div class="bg-slate-800 p-6 rounded-2xl shadow-xl border border-slate-700">
                                <h2 class="text-xl font-semibold mb-6 text-white">Pilih Materi Pembelajaran</h2>
                                <div class="grid gap-4">
                                    <button onclick="selectLearningMode('bayangan')" class="p-4 bg-indigo-600 hover:bg-indigo-700 rounded-xl text-left transition-all flex items-center gap-4 group">
                                        <span class="text-2xl group-hover:scale-110 transition-transform">üìç</span>
                                        <div>
                                            <div class="font-bold">Mencari Bayangan</div>
                                            <div class="text-xs text-indigo-200 mt-1">Diketahui Titik A dan Translasi T</div>
                                        </div>
                                    </button>
                                    
                                    <button onclick="selectLearningMode('titik_asal')" class="p-4 bg-emerald-600 hover:bg-emerald-700 rounded-xl text-left transition-all flex items-center gap-4 group">
                                        <span class="text-2xl group-hover:scale-110 transition-transform">üîç</span>
                                        <div>
                                            <div class="font-bold">Mencari Titik Asal</div>
                                            <div class="text-xs text-emerald-200 mt-1">Diketahui Bayangan A' dan Translasi T</div>
                                        </div>
                                    </button>
                                    
                                    <button onclick="selectLearningMode('translasi')" class="p-4 bg-pink-600 hover:bg-pink-700 rounded-xl text-left transition-all flex items-center gap-4 group">
                                        <span class="text-2xl group-hover:scale-110 transition-transform">üìè</span>
                                        <div>
                                            <div class="font-bold">Mencari Vektor Translasi</div>
                                            <div class="text-xs text-pink-200 mt-1">Diketahui Titik A dan Bayangan A'</div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // 2. Render MODE GAME (YANG SEBELUMNYA HILANG)
            const activeSteps = getActiveSteps();
            const stepData = activeSteps[currentStep];
            
            // Generate choices jika belum ada
            if (!currentChoices) {
                currentChoices = shuffleArray(stepData.getChoices(currentProblem));
            }

            app.innerHTML = `
                <div class="w-full h-full grid-bg overflow-auto p-4">
                    <div class="max-w-3xl mx-auto">
                        <div class="flex items-center justify-between mb-6">
                            <button onclick="backToMenu()" class="text-sm bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg transition-colors border border-slate-700">
                                ‚Üê Menu Utama
                            </button>
                            <div class="text-sm font-semibold bg-indigo-900/50 text-indigo-300 px-4 py-2 rounded-full border border-indigo-500/30">
                                ${stepData.title} (${currentStep + 1}/${activeSteps.length})
                            </div>
                        </div>

                        <div class="bg-slate-800 rounded-2xl p-6 shadow-2xl border border-slate-700 fade-in">
                            
                            ${drawCoordinateSystem(currentProblem)}
                            
                            <div class="text-center mb-8 mt-4">
                                <h2 class="text-xl font-bold mb-2 text-white">${stepData.question}</h2>
                                <div class="text-sm text-slate-400 font-mono bg-slate-900/50 inline-block px-3 py-1 rounded">
                                    Soal: A(${currentProblem.point_x}, ${currentProblem.point_y}) | T(${currentProblem.translation_x}, ${currentProblem.translation_y})
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                ${currentChoices.map((choice, index) => {
                                    let btnClass = "bg-slate-700 hover:bg-slate-600 border-2 border-transparent";
                                    if (selectedAnswer === index) {
                                        btnClass = choice.correct ? "correct text-white border-emerald-500" : "incorrect text-white border-red-500";
                                    }
                                    return `
                                        <button 
                                            onclick="checkAnswer(${index})"
                                            disabled="${selectedAnswer !== null}"
                                            class="choice-btn w-full p-4 rounded-xl text-left font-medium ${btnClass}"
                                        >
                                            <div class="flex items-center justify-between">
                                                <span>${choice.text}</span>
                                                ${selectedAnswer === index ? (choice.correct ? '‚úÖ' : '‚ùå') : ''}
                                            </div>
                                        </button>
                                    `;
                                }).join('')}
                            </div>

                            <div class="text-center">
                                <button onclick="toggleHint()" class="text-xs text-indigo-400 hover:text-indigo-300 underline mb-2">
                                    ${showHint ? 'Sembunyikan Bantuan' : 'Butuh Bantuan?'}
                                </button>
                                ${showHint ? `
                                    <div class="bg-indigo-900/30 border border-indigo-500/30 p-3 rounded-lg text-sm text-indigo-200 mt-2 fade-in">
                                        üí° ${typeof stepData.hint === 'function' ? stepData.hint(currentProblem) : stepData.hint}
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        ${completedSteps.length > 0 ? `
                            <div class="mt-8 space-y-4">
                                <h3 class="font-bold text-slate-400 px-2">Langkah Selesai:</h3>
                                ${completedSteps.map(step => `
                                    <div class="bg-slate-800/50 border border-slate-700/50 p-4 rounded-xl flex items-start gap-3 opacity-70">
                                        <div class="text-green-500 mt-1">‚úì</div>
                                        <div>
                                            <div class="font-semibold text-sm text-slate-300">${step.title}</div>
                                            <div class="text-slate-400 text-sm mt-1">${step.explanation}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // Helper untuk toggle hint
        window.toggleHint = function() {
            showHint = !showHint;
            render();
        }

        // Render awal
        render();

  </script>
 </body>
</html>
